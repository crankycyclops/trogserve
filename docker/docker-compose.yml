version: '3.3'

services:

    # Trogdord and the web socket server will use redis to send and receive
    # messages to each other
    redis:
        image: redis:latest

    # Php-fpm + trogdord extension
    php:
        image: crankycyclops/php8.1-fpm-trogdord-ext:0.90.0
        volumes:
            - ..:/var/www/trogserve

    # Database for the PHP application
    database:
        image: mariadb:latest
        environment:
            MARIADB_RANDOM_ROOT_PASSWORD: 'yes'
            MARIADB_DATABASE: trogserve
            MARIADB_USER: trogserve
            MARIADB_PASSWORD: trogserve
        volumes:
            - type: volume
              source: trogserve_mysql
              target: /var/lib/mysql
              volume:
                nocopy: true

    # Trogdord
    #
    # TODO: should the directory where game definitions are stored be
    # a bind mount or a volume? I'm leaning toward a bind-mount so that
    # games can be easily added just by moving files into the right
    # directory on the host, but I'll think about this a little more.
    #
    # TODO: once I modify trogdord to allow includes from the root
    # trogdord.ini, I should then bind to a directory containing a
    # default container-specific configuration that can be modified
    # directly on the host.
    trogdord:
        image: crankycyclops/trogdord:0.90.0
        volumes:
            - type: volume
              source: trogdord_dumped_games
              target: /usr/var/trogdord/state
              volume:
                nocopy: true

    # Web socket server (the glue between the PHP application and trogdord)
    sockserve:
        image: crankycyclops/trogserve-websocket:master
        volumes:
            - type: bind
              source: ./sockserve/config.env
              target: /sockserve/config.env
              read_only: true

    # TODO: I still need to create a container for Nginx

volumes:

    # Trogserve's database will persist here
    trogserve_mysql:

    # trogdord will dump games here so that they can be restored later, even if the
    # container that dumped the game is destroyed
    trogdord_dumped_games: